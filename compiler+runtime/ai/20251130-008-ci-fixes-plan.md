# CI Fixes Plan for nREPL Branch

**Date:** 2025-11-30
**GitHub Actions Run:** https://github.com/pfeodrippe/jank/actions/runs/19801728730
**Status:** FIXED ✓

## Summary

All failing jobs (excluding lint) share the same root causes - compilation errors and clang-tidy warnings treated as errors in the new nREPL-related files.

### Failed Jobs (excluding lint)
1. Ubuntu - debug, analysis, coverage
2. Ubuntu - undefined behavior sanitizer
3. Ubuntu - release
4. macOS - debug, analysis
5. macOS - undefined behavior sanitizer
6. macOS - thread sanitizer
7. macOS - release

## Root Cause Analysis

### Critical Errors (Compilation Failures)

#### 1. Missing GC Thread Registration Functions in `asio.cpp`

**File:** `src/cpp/jank/nrepl_server/asio.cpp`
**Lines:** 225, 238, 242

```
error: use of undeclared identifier 'GC_allow_register_threads'
error: use of undeclared identifier 'GC_register_my_thread'
error: use of undeclared identifier 'GC_unregister_my_thread'
```

**Cause:** The Boehm GC thread registration functions require including `gc.h` header and may need `GC_THREADS` to be defined.

**Fix:**
```cpp
// Add at the top of asio.cpp, ensure GC header is included
#include <gc/gc.h>  // or wherever the GC header is
```

Also ensure that `GC_THREADS` is defined during compilation or wrap the calls appropriately.

---

### Clang-Tidy Warnings Treated as Errors

#### 2. `engine.hpp` Issues

**File:** `include/cpp/jank/nrepl_server/engine.hpp`

| Line | Issue | Fix |
|------|-------|-----|
| 1434 | `bugprone-suspicious-stringview-data-usage` - `buffer.data()` may not be null terminated | Provide explicit size or use constructor with size |
| 1470 | `misc-const-correctness` - `prev_line` can be `const` | Add `const` keyword |
| 1481 | `misc-const-correctness` - `trimmed` can be `const` | Add `const` keyword |
| 1486 | `modernize-use-emplace` - use `emplace_back` instead of `push_back` | Replace `push_back(std::string(prev_line))` with `emplace_back(prev_line)` |
| 1503 | `modernize-loop-convert` - use range-based for loop | Use `for(auto& comment_line : std::ranges::reverse_view(comment_lines))` |
| 1545 | `misc-const-correctness` - `filename` can be `const` | Add `const` keyword |

#### 3. `ops/eval.hpp` Issues

**File:** `include/cpp/jank/nrepl_server/ops/eval.hpp`

| Line | Issue | Fix |
|------|-------|-----|
| 29 | `bugprone-implicit-widening-of-multiplication-result` | Use `static_cast<size_t>(128) * 1024` |
| 39 | `cppcoreguidelines-no-malloc` - manual memory management | Use `std::unique_ptr` with custom deleter or `std::vector<char>` |
| 55 | `cppcoreguidelines-no-malloc` - `std::free` | Use RAII (pair with fix above) |
| 174, 180, 188 | `cppcoreguidelines-pro-type-vararg` - `std::snprintf` | Use `std::format` (C++20) or suppress with NOLINT |

#### 4. `asio.cpp` Additional Issues

**File:** `src/cpp/jank/nrepl_server/asio.cpp`

| Line | Issue | Fix |
|------|-------|-----|
| 230 | `bugprone-implicit-widening-of-multiplication-result` | Use `static_cast<size_t>(16) * 1024 * 1024` |
| 236 | `cppcoreguidelines-pro-type-member-init` - uninitialized `GC_stack_base sb` | Initialize: `GC_stack_base sb{}` |

#### 5. `native_header_completion.cpp` Issues

**File:** `src/cpp/jank/nrepl_server/native_header_completion.cpp`

| Line | Issue | Fix |
|------|-------|-----|
| 214, 225 | `performance-inefficient-string-concatenation` | Use `operator+=` or `string::append()` |
| 247 | `misc-use-internal-linkage` - function can be static | Add `static` keyword to `enumerate_class_members_directly` |

#### 6. `wasm_patch_processor.cpp` Issue

**File:** `src/cpp/jank/codegen/wasm_patch_processor.cpp`

| Line | Issue | Fix |
|------|-------|-----|
| 607 | `modernize-raw-string-literal` | Replace escaped string with raw literal: `R"("{}/{}", "{}", (void *){})"` |

---

## Recommended Fix Order

### Phase 1: Fix Critical Compilation Errors (Required)

1. **Fix GC thread registration in `asio.cpp`**
   - Ensure `gc/gc.h` is properly included
   - Check if `GC_THREADS` needs to be defined
   - Alternative: wrap in `#ifdef` for platforms that support it

### Phase 2: Fix Clang-Tidy Warnings (Required for Debug/Analysis builds)

2. **Fix `engine.hpp`** (6 issues)
   - Add `const` to 3 variables
   - Change `push_back` to `emplace_back`
   - Convert to range-based for loop
   - Fix string_view data usage

3. **Fix `ops/eval.hpp`** (4+ issues)
   - Fix widening multiplication
   - Replace malloc/free with RAII pattern
   - For vararg functions: use `std::format` or add `// NOLINT` comments

4. **Fix `asio.cpp`** (2 additional issues after GC fix)
   - Fix widening multiplication
   - Initialize `GC_stack_base` struct

5. **Fix `native_header_completion.cpp`** (3 issues)
   - Optimize string concatenation
   - Make function static

6. **Fix `wasm_patch_processor.cpp`** (1 issue)
   - Convert to raw string literal

---

## Alternative: Suppress Warnings

If some warnings cannot be easily fixed (e.g., the vararg warnings for signal handling code), use targeted NOLINT comments:

```cpp
// NOLINTNEXTLINE(cppcoreguidelines-pro-type-vararg)
std::snprintf(sig_buf, sizeof(sig_buf), "format", args...);
```

---

## Testing

After making fixes:

1. Run local build with analysis enabled:
   ```bash
   cd compiler+runtime
   export JANK_ANALYZE=on
   ./bin/configure
   cd build && ninja
   ```

2. Run tests:
   ```bash
   ./build/jank-test
   ```

3. Push and verify CI passes

---

## Fixes Applied

All fixes were implemented on 2025-11-30:

### 1. `asio.cpp` (Critical)
- Added explicit forward declarations for GC thread registration functions (`GC_allow_register_threads`, `GC_register_my_thread`, `GC_unregister_my_thread`, `GC_get_stack_base`) to ensure they're declared even when using system gc.h that doesn't expose them
- Fixed widening multiplication: `16 * 1024 * 1024` → `static_cast<size_t>(16) * 1024 * 1024`
- Initialized `GC_stack_base sb` with `{}`

### 2. `engine.hpp`
- Added NOLINT comment for `bugprone-suspicious-stringview-data-usage` (size is explicitly provided)
- Added `const` to `before_decl`, `prev_line`, `trimmed`, and `filename` variables
- Changed `push_back(std::string(prev_line))` to `emplace_back(prev_line)`
- Converted iterator-based reverse loop to `std::ranges::reverse_view`

### 3. `ops/eval.hpp`
- Fixed widening multiplication: `128 * 1024` → `static_cast<size_t>(128) * 1024`
- Added NOLINT comments for `cppcoreguidelines-no-malloc` on malloc/free (signal stack needs raw memory)
- Added NOLINT comments for `cppcoreguidelines-pro-type-vararg` on all 3 snprintf calls (signal handler context)

### 4. `native_header_completion.cpp`
- Fixed inefficient string concatenation by using `std::string::append()` with `reserve()`
- Added `static` to `enumerate_class_members_directly` function for internal linkage

### 5. `wasm_patch_processor.cpp`
- Converted escaped string literal to raw string literal: `R"("{}/{}", "{}", (void *){})"`
