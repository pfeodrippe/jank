# Automatic iOS AOT Module Loading

## Problem

Currently, iOS apps using jank AOT must manually:
1. Declare `extern "C"` for each `jank_load_*` function
2. Call each function in the correct dependency order
3. Update the code when modules are added/removed

This is error-prone and tedious. When the user commented out `jank_load_vybe_util()`, it should have broken the app (since other modules depend on it), but it didn't because the dependency is resolved at runtime via `intern_var()`.

## Current State

**In `sdf_viewer_ios.mm`:**
```cpp
// Manual declarations
extern "C" void* jank_load_clojure_core_native();
extern "C" void* jank_load_core();
extern "C" void* jank_load_string();
extern "C" void* jank_load_set();
extern "C" void* jank_load_walk();
extern "C" void* jank_load_vybe_util();
extern "C" void* jank_load_vybe_sdf_math();
// ... etc

// Manual loading in order
jank_load_clojure_core_native();
jank_load_core();
jank_load_string();
jank_load_set();
jank_load_walk();
jank_load_vybe_util();  // <-- must not be skipped!
// ... etc
```

**In `build_ios_jank_aot.sh`:**
```bash
VYBE_MODULES=(
    "vybe.util"
    "vybe.sdf.math"
    "vybe.sdf.state"
    "vybe.sdf.shader"
    "vybe.sdf.ui"
    "vybe.sdf.ios"
)
```

The build script already knows the module order!

## Solution: Generate `jank_aot_init.cpp`

Generate a C++ file during the AOT build that provides a single entry point:

```cpp
// Auto-generated by build_ios_jank_aot.sh
// DO NOT EDIT - This file is regenerated on each build

#pragma once

// Core library load functions
extern "C" void* jank_load_clojure_core_native();
extern "C" void* jank_load_core();
extern "C" void* jank_load_string();
extern "C" void* jank_load_set();
extern "C" void* jank_load_walk();
extern "C" void* jank_load_template();
extern "C" void* jank_load_test();

// Application module load functions
extern "C" void* jank_load_vybe_util();
extern "C" void* jank_load_vybe_sdf_math();
extern "C" void* jank_load_vybe_sdf_state();
extern "C" void* jank_load_vybe_sdf_shader();
extern "C" void* jank_load_vybe_sdf_ui();
extern "C" void* jank_load_vybe_sdf_ios();

// Single entry point - loads all modules in correct order
extern "C" void jank_aot_init() {
    // Core libraries (always needed)
    jank_load_clojure_core_native();
    jank_load_core();
    jank_load_string();
    jank_load_set();
    jank_load_walk();
    jank_load_template();
    jank_load_test();

    // Application modules (in dependency order)
    jank_load_vybe_util();
    jank_load_vybe_sdf_math();
    jank_load_vybe_sdf_state();
    jank_load_vybe_sdf_shader();
    jank_load_vybe_sdf_ui();
    jank_load_vybe_sdf_ios();
}
```

**In `sdf_viewer_ios.mm` (simplified):**
```cpp
extern "C" void jank_aot_init();

void initJank() {
    jank_init();
    jank_aot_init();  // Single call loads everything!
}
```

## Implementation Plan

### Step 1: Modify `build_ios_jank_aot.sh`

Add code to generate `jank_aot_init.cpp` after compiling modules:

```bash
# ============================================================================
# Step 1.5: Generate jank_aot_init.cpp
# ============================================================================
echo "Generating jank_aot_init.cpp..."

INIT_FILE="$IOS_GENERATED_DIR/jank_aot_init.cpp"

cat > "$INIT_FILE" << 'HEADER'
// Auto-generated by build_ios_jank_aot.sh
// DO NOT EDIT - This file is regenerated on each build

#include <iostream>

// Core library load functions
extern "C" void* jank_load_clojure_core_native();
extern "C" void* jank_load_core();
extern "C" void* jank_load_string();
extern "C" void* jank_load_set();
extern "C" void* jank_load_walk();
extern "C" void* jank_load_template();
extern "C" void* jank_load_test();

HEADER

# Add extern declarations for application modules
for module in "${VYBE_MODULES[@]}"; do
    func_name="jank_load_$(echo "$module" | tr '.' '_')"
    echo "extern \"C\" void* ${func_name}();" >> "$INIT_FILE"
done

cat >> "$INIT_FILE" << 'MIDDLE'

// Single entry point - loads all modules in correct order
extern "C" void jank_aot_init() {
    std::cout << "[jank] Loading core libraries..." << std::endl;

    // Core libraries (always needed)
    jank_load_clojure_core_native();
    jank_load_core();
    jank_load_string();
    jank_load_set();
    jank_load_walk();
    jank_load_template();
    jank_load_test();

    std::cout << "[jank] Loading application modules..." << std::endl;

MIDDLE

# Add load calls for application modules
for module in "${VYBE_MODULES[@]}"; do
    func_name="jank_load_$(echo "$module" | tr '.' '_')"
    echo "    std::cout << \"[jank] Loading $module...\" << std::endl;" >> "$INIT_FILE"
    echo "    ${func_name}();" >> "$INIT_FILE"
done

cat >> "$INIT_FILE" << 'FOOTER'

    std::cout << "[jank] All modules loaded successfully!" << std::endl;
}
FOOTER

echo "  Generated: $INIT_FILE"
```

### Step 2: Compile `jank_aot_init.cpp`

Add to the compilation loop or as a separate step:

```bash
echo "  Compiling jank_aot_init.cpp..."
clang++ $IOS_CXXFLAGS -c "$INIT_FILE" -o "$IOS_OBJ_DIR/jank_aot_init.o"
```

### Step 3: Update Xcode Project

Ensure `jank_aot_init.o` is linked. The xcodegen `project.yml` should include it.

### Step 4: Simplify `sdf_viewer_ios.mm`

Replace all the manual declarations and calls with:

```cpp
extern "C" void jank_aot_init();

void initJank() {
    std::cout << "[jank] Initializing jank runtime..." << std::endl;
    jank_init();
    jank_aot_init();
    std::cout << "[jank] Jank initialization complete!" << std::endl;
}
```

## Benefits

1. **Single function call** - No manual listing of modules
2. **Automatic dependency order** - Build script ensures correct order
3. **Self-documenting** - Generated file shows what's being loaded
4. **Easy to extend** - Just add module to `VYBE_MODULES` array
5. **Build-time validation** - Missing modules cause link errors, not runtime crashes

## Alternative Considered: Constructor Attributes

Using `__attribute__((constructor))` was considered but rejected because:
- Constructor order is not guaranteed by the linker
- Dependencies between modules require specific load order
- Would need complex priority system

## Files to Modify

1. `SdfViewerMobile/build_ios_jank_aot.sh` - Add generation of `jank_aot_init.cpp`
2. `SdfViewerMobile/sdf_viewer_ios.mm` - Simplify to use `jank_aot_init()`
3. `SdfViewerMobile/project.yml` - Ensure new .o file is linked (if needed)
