#!/usr/bin/env bb

(ns jank.test.native-header-completion
  (:require [babashka.process :as proc]
            [clojure.string :as str]
            [clojure.test :as t :refer [deftest run-test is]]))

(def this-nsym (ns-name *ns*))

(defn check-output [cmd expected-str]
  (let [{:keys [exit out err] :as res} (apply proc/shell {:out :string
                                                          :err :string
                                                          :continue true}
                                              cmd)]
    (when (not= 0 exit)
      (println "STDERR:" err))
    (is (= 0 exit) (str "Command failed: " cmd))
    (is (str/includes? out expected-str) (str "Output did not contain: " expected-str "\nOutput: " out))
    res))

(deftest native-header-completion-test
  ;; Run with -I to include the current directory where test_native.hpp is located
  (check-output ["../../../build/jank" "-I." "run" "test.jank"]
                "All native header autocompletion tests passed!"))

(defn -main []
  (System/exit
    (if (t/successful? (t/run-tests this-nsym))
      0
      1)))

(when (= *file* (System/getProperty "babashka.file"))
  (apply -main *command-line-args*))
