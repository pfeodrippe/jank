#!/usr/bin/env bash

set -euo pipefail

here="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "${here}/../../.." && pwd)"
work_dir="${here}/build"
rm -rf "${work_dir}"
mkdir -p "${work_dir}"

module_path="${here}/src"
uname_out="$(uname)"
ext="so"
host_linker_libs=("-ldl")
if [[ "${uname_out}" == "Darwin" ]]; then
  ext="dylib"
  host_linker_libs=()
fi

shared_lib="${work_dir}/libshared_entrypoint.${ext}"
host_runner="${work_dir}/host-runner"

jank --module-path "${module_path}" compile dynamic.shared-entrypoint --shared -o "${shared_lib}"

clang_args=("${here}/host/host_runner.c" "-std=c11" "-Wall" "-Wextra" "-Werror" "-pedantic" "-lm" "-o" "${host_runner}")
if ((${#host_linker_libs[@]} > 0)); then
  clang_args+=("${host_linker_libs[@]}")
fi
clang "${clang_args[@]}"

llvm_lib_dir="${repo_root}/build/llvm-install/usr/local/lib"
runtime_lib_path="${llvm_lib_dir}:${repo_root}/build"
if [[ "${uname_out}" == "Darwin" ]]; then
  export DYLD_LIBRARY_PATH="${runtime_lib_path}${DYLD_LIBRARY_PATH:+:${DYLD_LIBRARY_PATH}}"
else
  export LD_LIBRARY_PATH="${runtime_lib_path}${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"
fi

output="$(${host_runner} "${shared_lib}")"

expected="Main called!
make_point => (4, 1.5)
translate_point => (7, 3.5)
pointer roundtrip ok"

if [[ "${output}" != "${expected}" ]]; then
  echo "unexpected shared output: '${output}'" >&2
  exit 1
fi
