; Test that native C++ pointers can be returned and printed with *allow-native-return* enabled
;
; The *allow-native-return* dynamic var allows tools to control whether native C++ values
; that aren't convertible to jank objects are wrapped in a printable string representation
; like "(MyData*) 0x7fff..." instead of throwing an error.
;
; This works because the check for *allow-native-return* happens at RUNTIME in the
; generated code, not at analysis time. This allows (binding [*allow-native-return* true] ...)
; to work correctly.
;
(cpp/raw "namespace jank::cpp::native_print::pass_pointer_return
          {
            struct MyData
            {
              int value{ 42 };
            };
            MyData global_data;
            MyData* get_data_ptr()
            {
              return &global_data;
            }
          }")

; Use binding to enable native return printing
(binding [*allow-native-return* true]
  (let* [ptr-str (cpp/jank.cpp.native_print.pass_pointer_return.get_data_ptr)]
    ; Verify it's a string containing the expected format like "(Type *) 0x..."
    (if (and (string? ptr-str)
             (.contains ptr-str "MyData")
             (.contains ptr-str "0x"))
      :success
      (throw (ex-info "Expected string result with type and address" {:actual ptr-str})))))
